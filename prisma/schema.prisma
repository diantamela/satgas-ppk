generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  SATGAS
  REKTOR
}

enum ReportStatus {
  PENDING
  VERIFIED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum NotificationType {
  REPORT_STATUS_CHANGED
  REPORT_ASSIGNED
  NEW_RECOMMENDATION
  DECISION_MADE
  DOCUMENT_UPLOADED
}

enum DocumentType {
  EVIDENCE
  INVESTIGATION_REPORT
  OFFICIAL_LETTER
  PROCEEDINGS
  RECOMMENDATION
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum DecisionType {
  APPROVED
  REJECTED
  FOLLOW_UP
}

enum RecommendationStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
  IMPLEMENTED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum Affiliation {
  STUDENT
  FACULTY
  STAFF
  GUEST
}

enum InvestigationMethod {
  INTERVIEW
  WRITTEN_CLARIFICATION
  LOCATION_OBSERVATION
  DIGITAL_EVIDENCE_COLLECTION
  MEDIATION
  OTHER
}

enum InvestigationParty {
  VICTIM_SURVIVOR
  REPORTED_PERSON
  WITNESS
  OTHER_PARTY
}

enum TeamRole {
  TEAM_LEADER
  NOTE_TAKER
  PSYCHOLOGICAL_SUPPORT
  LEGAL_SUPPORT
  INVESTIGATOR
  OTHER
}

enum ProcessStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AccessLevel {
  CORE_TEAM_ONLY
  FULL_SATGAS
  LEADERSHIP_ONLY
}

enum InvestigationActivityType {
  VICTIM_INTERVIEW
  WITNESS_INTERVIEW
  REPORTED_PERSON_INTERVIEW
  EVIDENCE_COLLECTION
  LOCATION_OBSERVATION
  MEDIATION_SESSION
  CONFRONTATION
  FOLLOW_UP_INTERVIEW
  CASE_REVIEW
  OTHER
}

enum EquipmentItem {
  CAMERA_RECORDER
  AUDIO_RECORDER
  PRINTED_FORMS
  PROJECTOR_SCREEN
  COMPUTER_LAPTOP
  PRINTER
  NOTARY_PRESENCE
  LEGAL_COUNSEL
  PSYCHOLOGICAL_SUPPORT
  TRANSLATOR
  SECURITY_PERSONNEL
  VIDEO_CONFERENCE_SETUP
}

enum CompanionRequirement {
  PSYCHOLOGIST
  COUNSELOR
  LEGAL_ADVISOR
  RELIGIOUS_COUNSELOR
  FAMILY_MEMBER
  FRIEND_SUPPORT
  ADVOCATE
  NONE
}

enum RecommendedAction {
  SCHEDULE_NEXT_SESSION
  CALL_OTHER_PARTY
  REQUIRE_PSYCHOLOGICAL_SUPPORT
  REQUIRE_LEGAL_SUPPORT
  CASE_TERMINATED
  FORWARD_TO_REKTORAT
  MEDIATION_SESSION
  EVIDENCE_ANALYSIS
  WITNESS_REINTERVIEW
  OTHER
}

enum CaseStatusAfterResult {
  UNDER_INVESTIGATION
  EVIDENCE_COLLECTION
  STATEMENT_ANALYSIS
  PENDING_EXTERNAL_INPUT
  READY_FOR_RECOMMENDATION
  CLOSED_TERMINATED
  FORWARDED_TO_REKTORAT
}


model Gallery {
  id          String   @id @default(cuid())
  title       String
  description String
  date        String
  location    String
  category    String
  image       String   // Path to image
  uploadedBy  User?                 @relation(name: "UserUploadedGallery", fields: [uploadedById], references: [id], onDelete: SetNull)
  uploadedById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([uploadedById])
  @@index([createdAt])
}

model InvestigationResult {
  id                    String    @id @default(cuid())
  processId             String @unique
  reportId              String
  
  // Auto-populated metadata from scheduling
  schedulingId          String?
  schedulingTitle       String?
  schedulingDateTime    DateTime?
  schedulingLocation    String?
  caseTitle             String?
  reportNumber          String?
  
  // Attendance tracking
  satgasMembersPresent  Json?     // Array of satgas members who attended
  partiesPresent        Json?     // Array of parties involved with attendance status
  identityVerified      Boolean   @default(false)
  attendanceNotes       String?
  
  // Key investigation notes
  partiesStatementSummary String?  // Ringkasan keterangan pihak
  newPhysicalEvidence     String?  // Temuan bukti fisik/digital baru
  evidenceFiles           Json?    // Uploaded evidence files
  statementConsistency    String?  // Konsistensi keterangan
  
  // Interim conclusions and recommendations
  sessionInterimConclusion    String?
  recommendedImmediateActions Json?    // Array of recommended actions
  caseStatusAfterResult       CaseStatusAfterResult @default(UNDER_INVESTIGATION)
  statusChangeReason          String?
  
  // Digital authentication
  dataVerificationConfirmed   Boolean  @default(false)
  creatorDigitalSignature     String?
  creatorSignatureDate        DateTime?
  chairpersonDigitalSignature String?
  chairpersonSignatureDate    DateTime?
  
  // Additional fields
  partiesDetailedAttendance   Json?
  recommendedActionsDetails   Json?
  documentHash                String?
  internalSatgasNotes         String?
  
  // Timestamps
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
  
  // Relations
  process                     InvestigationProcess @relation(fields: [processId], references: [id])
  report                      Report              @relation(fields: [reportId], references: [id])
  
  @@index([reportId])
  @@index([processId])
  @@index([createdAt])
  @@index([schedulingDateTime])
}

model Recommendation {
  id            String              @id @default(cuid())
  report        Report              @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId      String
  title         String
  description   String
  content       String              // The actual recommendation text
  status        RecommendationStatus @default(PENDING)
  priority      Priority            @default(MEDIUM)
  createdBy     User                @relation("RecommendationCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  createdById   String
  approvedBy    User?               @relation("RecommendationApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedById  String?
  approvedAt    DateTime?
  rejectionReason String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([reportId])
  @@index([status])
  @@index([createdById])
  @@index([createdAt])
}

model User {
  id            String                  @id @default(cuid())
  // Email diset ke unique case-insensitive (tanpa citext untuk kompatibilitas)
  email         String                  @unique
  password      String
  name          String
  role          Role                    @default(USER)
  affiliation   Affiliation             @default(STUDENT)
  isActive      Boolean                 @default(true)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  // Relations
  reportsAsReporter     Report[]                @relation("ReportReporter")
  reportsAsAssignee     Report[]                @relation("ReportAssignee")
  sessions              Session[]               @relation(name: "UserSessions")
  assignedNotifications Notification[]
  createdArticles       Article[]
  timelineEntries       ReportTimeline[]        @relation(name: "UserTimelineEntries")
  uploadedDocuments     InvestigationDocument[] @relation(name: "UserDocuments")
  activityLogs          ActivityLog[]
  uploadedGallery       Gallery[] @relation(name: "UserUploadedGallery")
  createdProcesses      InvestigationProcess[] @relation(name: "UserCreatedProcesses")
  teamMemberships       InvestigationTeamMember[]
  uploadedAttachments   InvestigationAttachment[] @relation(name: "UserUploadedAttachments")
  createdRecommendations Recommendation[] @relation("RecommendationCreatedBy")
  approvedRecommendations Recommendation[] @relation("RecommendationApprovedBy")

  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  user      User     @relation(name: "UserSessions", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  tokenHash String   @unique
  userAgent String?
  ip        String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([expiresAt])
}

model Report {
   id                     String              @id @default(cuid())
   reportNumber           String              @unique
   title                  String
   description            String
   category               String?             // Kategori laporan (e.g., "Pelecehan Seksual", "Kekerasan Verbal")
   severity               String?             // Tingkat keparahan (e.g., "Tinggi", "Sedang", "Rendah")
   incidentDate           DateTime?
   incidentLocation       String?
   status                 ReportStatus        @default(PENDING)
   investigationProgress Int?                @default(0) // Progress investigasi dalam persen (0-100)
   recommendationStatus   RecommendationStatus? @default(PENDING)
   finalDecision          DecisionType?
   decisionNotes          String?
   reporter               User                @relation(name: "ReportReporter", fields: [reporterId], references: [id], onDelete: Restrict)
   reporterId             String
   reporterEmail          String?             // Store email for data integrity (optional for migration)
   assignee               User?               @relation(name: "ReportAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
   assigneeId             String?
   recommendation         String?
   evidenceCount          Int?                @default(0) // Number of evidence files uploaded
   // Investigation Scheduling Fields (different from InvestigationProcess)
   scheduledDate          DateTime?           // Date when investigation is scheduled to start (planning phase)
   scheduledBy            String?             // User ID who scheduled the investigation
   scheduledNotes         String?             // Notes about the scheduling
   createdAt              DateTime            @default(now())
   updatedAt              DateTime            @updatedAt

   // Relations
   timelines    ReportTimeline[]
   documents    InvestigationDocument[]
   activityLogs ActivityLog[] @relation(name: "ReportActivityLogs")
   processes    InvestigationProcess[]
   recommendations Recommendation[]
   results      InvestigationResult[]

   @@index([reporterId])
   @@index([assigneeId])
   @@index([status])
   @@index([createdAt])
   @@index([status, updatedAt])
   @@index([recommendationStatus])
}

// InvestigationProcess: Stores data for ongoing/active investigation processes
// This is different from scheduling (see Report.scheduledDate fields)
// This table contains actual execution details of investigations in progress
model InvestigationProcess {
    id                    String                @id @default(cuid())
    report                Report                @relation(fields: [reportId], references: [id], onDelete: Cascade)
    reportId              String

    // Block 1: Info Dasar Sesi
    startDateTime         DateTime?             // Tanggal & jam mulai (opsional)
    endDateTime           DateTime?             // Tanggal & jam selesai (opsional)
    location              String                // Lokasi investigasi
    methods               InvestigationMethod[] // Metode/bentuk kegiatan (multi-select)
    partiesInvolved       InvestigationParty[]  // Pihak yang dilibatkan (multi-select)
    otherPartiesDetails   String?               // Detail pihak lain jika dipilih

    // Block 2: Tim & Tugas
    teamMembers           InvestigationTeamMember[]
    consentObtained       Boolean               @default(false) // Persetujuan diperoleh
    consentDocumentation  String?               // Cara dokumentasi persetujuan (tertulis/lisan terekam)
    riskNotes             String?               // Catatan risiko & keamanan

    // Block 3: Output & Status
    planSummary           String?               // Ringkasan rencana
    attachments           InvestigationAttachment[]
    followUpAction        String?               // Tindakan lanjut (lanjut/stop)
    followUpDate          DateTime?             // Jadwal tindak lanjut
    followUpNotes         String?               // Catatan tindak lanjut
    status                ProcessStatus         @default(IN_PROGRESS)
    accessLevel           AccessLevel           @default(CORE_TEAM_ONLY)

    createdBy             User?                 @relation(name: "UserCreatedProcesses", fields: [createdById], references: [id], onDelete: SetNull)
    createdById           String?
    createdAt             DateTime              @default(now())
    updatedAt             DateTime              @updatedAt

    // Relations
   results            InvestigationResult[]
    activityTitle         String?               // Judul kegiatan spesifik
    activityType          InvestigationActivityType? // Jenis kegiatan investigasi
    caseAutoInfo          Json?                 // Auto-populated case information
    equipmentChecklist    EquipmentItem[]       // Equipment/logistics needed
    otherEquipmentDetails String?               // Additional equipment requirements
    companionRequirements CompanionRequirement[] // Required support persons
    companionDetails      String?               // Details about companions
    internalSatgasNotes   String?               // OTAN-only internal notes
    nextStepsAfterCompletion String?            // Detailed follow-up planning
    estimatedDuration     Int?                  // Duration in minutes
    caseSummary           String?               // Auto-populated case summary

    @@index([reportId])
    @@index([status])
    @@index([createdAt])
    @@index([activityType])
    @@index([estimatedDuration])
}

model InvestigationTeamMember {
   id              String      @id @default(cuid())
   process         InvestigationProcess @relation(fields: [processId], references: [id], onDelete: Cascade)
   processId       String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  role            TeamRole
  customRole      String?     // Jika role OTHER, isi custom role
  isChairPerson   Boolean     @default(false)  // Whether this member is the chairman
  responsibilityNotes String?  // Specific responsibilities for this member

  @@index([processId])
  @@index([userId])
  @@index([isChairPerson])
  @@unique([processId, userId]) // One user per process
}

model InvestigationAttachment {
   id          String                @id @default(cuid())
   process     InvestigationProcess  @relation(fields: [processId], references: [id], onDelete: Cascade)
   processId   String
  fileName    String
  fileType    String
  fileSize    Int
  storagePath String
  description String?
  uploadedBy  User?                 @relation(name: "UserUploadedAttachments", fields: [uploadedById], references: [id], onDelete: SetNull)
  uploadedById String?
  createdAt   DateTime              @default(now())

  @@index([processId])
  @@index([uploadedById])
}



model ReportTimeline {
  id        String       @id @default(cuid())
  report    Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId  String
  status    ReportStatus
  notes     String?
  user      User?        @relation(name: "UserTimelineEntries", fields: [userId], references: [id], onDelete: SetNull)
  userId    String?
  timestamp DateTime     @default(now())

  @@index([reportId])
  @@index([userId])
  @@index([timestamp])
}

model InvestigationDocument {
  id           String       @id @default(cuid())
  report       Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId     String
  fileName     String
  fileType     String
  fileSize     Int
  // Simpan path di storage, buat signed URL saat akses
  storagePath  String
  documentType DocumentType
  uploadedBy   User?        @relation(name: "UserDocuments", fields: [uploadedById], references: [id], onDelete: SetNull)
  uploadedById String?
  description  String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([reportId])
  @@index([uploadedById])
}

model Notification {
  id                String           @id @default(cuid())
  user              User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId            String?
  type              NotificationType
  title             String
  message           String
  isRead            Boolean          @default(false)
  relatedEntityId   String?
  relatedEntityType String?
  createdAt         DateTime         @default(now())
  readAt            DateTime?
  updatedAt         DateTime         @updatedAt

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Article {
  id          String        @id @default(cuid())
  slug        String        @unique
  title       String
  content     String
  excerpt     String?
  status      ArticleStatus @default(DRAFT)
  author      User?         @relation(fields: [authorId], references: [id], onDelete: SetNull)
  authorId    String?
  publishedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([authorId])
  @@index([status])
  @@index([publishedAt])
}

model ActivityLog {
  id          String   @id @default(cuid())
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId      String?
  action      String
  entityType  String?
  entityId    String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  report      Report?  @relation(name: "ReportActivityLogs", fields: [reportId], references: [id], onDelete: SetNull)
  reportId    String?

  @@index([userId])
  @@index([reportId])
  @@index([timestamp])
  @@index([action])
}


