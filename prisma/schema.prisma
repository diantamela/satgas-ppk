generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  SATGAS
  REKTOR
}

enum ReportStatus {
  PENDING
  VERIFIED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum NotificationType {
  REPORT_STATUS_CHANGED
  REPORT_ASSIGNED
  NEW_RECOMMENDATION
  DECISION_MADE
  DOCUMENT_UPLOADED
}

enum DocumentType {
  EVIDENCE
  INVESTIGATION_REPORT
  OFFICIAL_LETTER
  PROCEEDINGS
  RECOMMENDATION
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum DecisionType {
  APPROVED
  REJECTED
  FOLLOW_UP
}

enum RecommendationStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
  IMPLEMENTED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum Affiliation {
  STUDENT
  FACULTY
  STAFF
  GUEST
}

enum InvestigationMethod {
  INTERVIEW
  WRITTEN_CLARIFICATION
  LOCATION_OBSERVATION
  DIGITAL_EVIDENCE_COLLECTION
  MEDIATION
  OTHER
}

enum InvestigationParty {
  VICTIM_SURVIVOR
  REPORTED_PERSON
  WITNESS
  OTHER_PARTY
}

enum TeamRole {
  TEAM_LEADER
  NOTE_TAKER
  PSYCHOLOGICAL_SUPPORT
  LEGAL_SUPPORT
  INVESTIGATOR
  OTHER
}

enum ScheduleStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  RESCHEDULED
}

enum AccessLevel {
  CORE_TEAM_ONLY
  FULL_SATGAS
  LEADERSHIP_ONLY
}

enum ActivityType {
  SCHEDULED_INVESTIGATION
  INTERVIEW_CONDUCTED
  EVIDENCE_COLLECTED
  SITE_VISIT
  DOCUMENT_REVIEW
  WITNESS_STATEMENT
  MEDIATION_SESSION
  FOLLOW_UP_ACTION
  OTHER_ACTIVITY
}

model Gallery {
  id          String   @id @default(cuid())
  title       String
  description String
  date        String
  location    String
  category    String
  image       String   // Path to image
  uploadedBy  User?                 @relation(name: "UserUploadedGallery", fields: [uploadedById], references: [id], onDelete: SetNull)
  uploadedById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([uploadedById])
  @@index([createdAt])
}

model Recommendation {
  id            String              @id @default(cuid())
  report        Report              @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId      String
  title         String
  description   String
  content       String              // The actual recommendation text
  status        RecommendationStatus @default(PENDING)
  priority      Priority            @default(MEDIUM)
  createdBy     User                @relation("RecommendationCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  createdById   String
  approvedBy    User?               @relation("RecommendationApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedById  String?
  approvedAt    DateTime?
  rejectionReason String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([reportId])
  @@index([status])
  @@index([createdById])
  @@index([createdAt])
}

model User {
  id            String                  @id @default(cuid())
  // Email diset ke unique case-insensitive (tanpa citext untuk kompatibilitas)
  email         String                  @unique
  password      String
  name          String
  role          Role                    @default(USER)
  affiliation   Affiliation             @default(STUDENT)
  isActive      Boolean                 @default(true)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  // Relations
  reportsAsReporter     Report[]                @relation("ReportReporter")
  reportsAsAssignee     Report[]                @relation("ReportAssignee")
  sessions              Session[]               @relation(name: "UserSessions")
  assignedNotifications Notification[]
  createdArticles       Article[]
  timelineEntries       ReportTimeline[]        @relation(name: "UserTimelineEntries")
  uploadedDocuments     InvestigationDocument[] @relation(name: "UserDocuments")
  activityLogs          ActivityLog[]
  uploadedGallery       Gallery[] @relation(name: "UserUploadedGallery")
  createdSchedules      InvestigationSchedule[] @relation(name: "UserCreatedSchedules")
  teamMemberships       InvestigationTeamMember[]
  uploadedAttachments   InvestigationAttachment[] @relation(name: "UserUploadedAttachments")
  conductedActivities   InvestigationActivity[]
  activityAttachments   InvestigationActivityAttachment[] @relation(name: "ActivityAttachmentUploader")
  createdRecommendations Recommendation[] @relation("RecommendationCreatedBy")
  approvedRecommendations Recommendation[] @relation("RecommendationApprovedBy")

  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  user      User     @relation(name: "UserSessions", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  tokenHash String   @unique
  userAgent String?
  ip        String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([expiresAt])
}

model Report {
   id                     String              @id @default(cuid())
   reportNumber           String              @unique
   title                  String
   description            String
   category               String?             // Kategori laporan (e.g., "Pelecehan Seksual", "Kekerasan Verbal")
   severity               String?             // Tingkat keparahan (e.g., "Tinggi", "Sedang", "Rendah")
   incidentDate           DateTime?
   incidentLocation       String?
   status                 ReportStatus        @default(PENDING)
   investigationProgress Int?                @default(0) // Progress investigasi dalam persen (0-100)
   recommendationStatus   RecommendationStatus? @default(PENDING)
   finalDecision          DecisionType?
   decisionNotes          String?
   reporter               User                @relation(name: "ReportReporter", fields: [reporterId], references: [id], onDelete: Restrict)
   reporterId             String
   reporterEmail          String?             // Store email for data integrity (optional for migration)
   assignee               User?               @relation(name: "ReportAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
   assigneeId             String?
   recommendation         String?
   evidenceCount          Int?                @default(0) // Number of evidence files uploaded
   scheduledDate          DateTime?           // Date when investigation is scheduled to start
   scheduledBy            String?             // User ID who scheduled the investigation
   scheduledNotes         String?             // Notes about the scheduling
   createdAt              DateTime            @default(now())
   updatedAt              DateTime            @updatedAt

   // Relations
   timelines    ReportTimeline[]
   documents    InvestigationDocument[]
   activityLogs ActivityLog[] @relation(name: "ReportActivityLogs")
   schedules    InvestigationSchedule[]
   activities     InvestigationActivity[]
   recommendations Recommendation[]

   @@index([reporterId])
   @@index([assigneeId])
   @@index([status])
   @@index([createdAt])
   @@index([status, updatedAt])
   @@index([recommendationStatus])
}

model InvestigationSchedule {
   id                    String                @id @default(cuid())
   report                Report                @relation(fields: [reportId], references: [id], onDelete: Cascade)
   reportId              String

   // Block 1: Info Dasar Sesi
   startDateTime         DateTime?             // Tanggal & jam mulai (opsional)
   endDateTime           DateTime?             // Tanggal & jam selesai (opsional)
  location              String                // Lokasi investigasi
  methods               InvestigationMethod[] // Metode/bentuk kegiatan (multi-select)
  partiesInvolved       InvestigationParty[]  // Pihak yang dilibatkan (multi-select)
  otherPartiesDetails   String?               // Detail pihak lain jika dipilih

  // Block 2: Tim & Tugas
  teamMembers           InvestigationTeamMember[]
  consentObtained       Boolean               @default(false) // Persetujuan diperoleh
  consentDocumentation  String?               // Cara dokumentasi persetujuan (tertulis/lisan terekam)
  riskNotes             String?               // Catatan risiko & keamanan

  // Block 3: Output & Status
  planSummary           String?               // Ringkasan rencana
  attachments           InvestigationAttachment[]
  activities            InvestigationActivity[]
  followUpAction        String?               // Tindakan lanjut (lanjut/stop)
  followUpDate          DateTime?             // Jadwal tindak lanjut
  followUpNotes         String?               // Catatan tindak lanjut
  status                ScheduleStatus        @default(SCHEDULED)
  accessLevel           AccessLevel           @default(CORE_TEAM_ONLY)

  createdBy             User?                 @relation(name: "UserCreatedSchedules", fields: [createdById], references: [id], onDelete: SetNull)
  createdById           String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  @@index([reportId])
  @@index([status])
  @@index([createdAt])
}

model InvestigationTeamMember {
  id              String      @id @default(cuid())
  schedule        InvestigationSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  scheduleId      String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  role            TeamRole
  customRole      String?     // Jika role OTHER, isi custom role

  @@index([scheduleId])
  @@index([userId])
  @@unique([scheduleId, userId]) // One user per schedule
}

model InvestigationAttachment {
  id          String                @id @default(cuid())
  schedule    InvestigationSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  scheduleId  String
  fileName    String
  fileType    String
  fileSize    Int
  storagePath String
  description String?
  uploadedBy  User?                 @relation(name: "UserUploadedAttachments", fields: [uploadedById], references: [id], onDelete: SetNull)
  uploadedById String?
  createdAt   DateTime              @default(now())

  @@index([scheduleId])
  @@index([uploadedById])
}

model InvestigationActivity {
  id                String                @id @default(cuid())
  report            Report                @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId          String
  schedule          InvestigationSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  scheduleId        String?

  // Activity details
  activityType      ActivityType
  title             String                // Brief title of the activity
  description       String                // Detailed description of what was done
  location          String?               // Where the activity took place
  startDateTime     DateTime              // When the activity started
  endDateTime       DateTime?             // When the activity ended
  duration          Int?                  // Duration in minutes

  // Participants
  participants      String[]              // Names/emails of people involved
  conductedBy       User                  @relation(fields: [conductedById], references: [id], onDelete: Restrict)
  conductedById     String

  // Outcomes and notes
  outcomes          String?               // What was accomplished/learned
  challenges        String?               // Any challenges encountered
  recommendations   String?               // Recommendations for next steps
  attachments       InvestigationActivityAttachment[]

  // Metadata
  isConfidential    Boolean               @default(false)
  accessLevel       AccessLevel           @default(CORE_TEAM_ONLY)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  @@index([reportId])
  @@index([scheduleId])
  @@index([conductedById])
  @@index([activityType])
  @@index([createdAt])
}

model InvestigationActivityAttachment {
  id            String                @id @default(cuid())
  activity      InvestigationActivity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  activityId    String
  fileName      String
  fileType      String
  fileSize      Int
  storagePath   String
  description   String?
  uploadedBy    User?                 @relation(name: "ActivityAttachmentUploader", fields: [uploadedById], references: [id], onDelete: SetNull)
  uploadedById  String?
  createdAt     DateTime              @default(now())

  @@index([activityId])
  @@index([uploadedById])
}

model ReportTimeline {
  id        String       @id @default(cuid())
  report    Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId  String
  status    ReportStatus
  notes     String?
  user      User?        @relation(name: "UserTimelineEntries", fields: [userId], references: [id], onDelete: SetNull)
  userId    String?
  timestamp DateTime     @default(now())

  @@index([reportId])
  @@index([userId])
  @@index([timestamp])
}

model InvestigationDocument {
  id           String       @id @default(cuid())
  report       Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId     String
  fileName     String
  fileType     String
  fileSize     Int
  // Simpan path di storage, buat signed URL saat akses
  storagePath  String
  documentType DocumentType
  uploadedBy   User?        @relation(name: "UserDocuments", fields: [uploadedById], references: [id], onDelete: SetNull)
  uploadedById String?
  description  String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([reportId])
  @@index([uploadedById])
}

model Notification {
  id                String           @id @default(cuid())
  user              User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId            String?
  type              NotificationType
  title             String
  message           String
  isRead            Boolean          @default(false)
  relatedEntityId   String?
  relatedEntityType String?
  createdAt         DateTime         @default(now())
  readAt            DateTime?
  updatedAt         DateTime         @updatedAt

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Article {
  id          String        @id @default(cuid())
  slug        String        @unique
  title       String
  content     String
  excerpt     String?
  status      ArticleStatus @default(DRAFT)
  author      User?         @relation(fields: [authorId], references: [id], onDelete: SetNull)
  authorId    String?
  publishedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([authorId])
  @@index([status])
  @@index([publishedAt])
}

model ActivityLog {
  id          String   @id @default(cuid())
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId      String?
  action      String
  entityType  String?
  entityId    String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  report      Report?  @relation(name: "ReportActivityLogs", fields: [reportId], references: [id], onDelete: SetNull)
  reportId    String?

  @@index([userId])
  @@index([reportId])
  @@index([timestamp])
  @@index([action])
}
