generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DIRECT_URL")    // pakai direct untuk runtime to avoid pgbouncer cache
  directUrl = env("DIRECT_URL")    // pakai port 5432 untuk migrate
}

enum Role {
  USER
  SATGAS
  REKTOR
}

enum ReportStatus {
  PENDING
  VERIFIED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum NotificationType {
  REPORT_STATUS_CHANGED
  REPORT_ASSIGNED
  NEW_RECOMMENDATION
  DECISION_MADE
  DOCUMENT_UPLOADED
}

enum DocumentType {
  EVIDENCE
  INVESTIGATION_REPORT
  OFFICIAL_LETTER
  PROCEEDINGS
  RECOMMENDATION
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum DecisionType {
  APPROVED
  REJECTED
  FOLLOW_UP
}

enum RecommendationStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
}

enum Affiliation {
  STUDENT
  FACULTY
  STAFF
  GUEST
}

model User {
  id            String                  @id @default(cuid())
  // Email diset ke unique case-insensitive (tanpa citext untuk kompatibilitas)
  email         String                  @unique
  password      String
  name          String
  role          Role                    @default(USER)
  affiliation   Affiliation             @default(STUDENT)
  isActive      Boolean                 @default(true)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  // Relations
  reportsAsReporter     Report[]                @relation("ReportReporter")
  reportsAsAssignee     Report[]                @relation("ReportAssignee")
  sessions              Session[]               @relation(name: "UserSessions")
  assignedNotifications Notification[]
  createdArticles       Article[]
  timelineEntries       ReportTimeline[]        @relation(name: "UserTimelineEntries")
  uploadedDocuments     InvestigationDocument[] @relation(name: "UserDocuments")
  activityLogs          ActivityLog[]

  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  user      User     @relation(name: "UserSessions", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  tokenHash String   @unique
  userAgent String?
  ip        String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([expiresAt])
}

model Report {
   id                     String              @id @default(cuid())
   reportNumber           String              @unique
   title                  String
   description            String
   category               String?             // Kategori laporan (e.g., "Pelecehan Seksual", "Kekerasan Verbal")
   severity               String?             // Tingkat keparahan (e.g., "Tinggi", "Sedang", "Rendah")
   incidentDate           DateTime?
   incidentLocation       String?
   status                 ReportStatus        @default(PENDING)
   investigationProgress Int?                @default(0) // Progress investigasi dalam persen (0-100)
   recommendationStatus   RecommendationStatus? @default(PENDING)
   finalDecision          DecisionType?
   decisionNotes          String?
   reporter               User                @relation(name: "ReportReporter", fields: [reporterId], references: [id], onDelete: Restrict)
   reporterId             String
   reporterEmail          String?             // Store email for data integrity (optional for migration)
   assignee               User?               @relation(name: "ReportAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
   assigneeId             String?
   recommendation         String?
   evidenceCount          Int?                @default(0) // Number of evidence files uploaded
   scheduledDate          DateTime?           // Date when investigation is scheduled to start
   scheduledBy            String?             // User ID who scheduled the investigation
   scheduledNotes         String?             // Notes about the scheduling
   createdAt              DateTime            @default(now())
   updatedAt              DateTime            @updatedAt

   // Relations
   timelines    ReportTimeline[]
   documents    InvestigationDocument[]
   activityLogs ActivityLog[] @relation(name: "ReportActivityLogs")

   @@index([reporterId])
   @@index([assigneeId])
   @@index([status])
   @@index([createdAt])
   @@index([status, updatedAt])
   @@index([recommendationStatus])
}

model ReportTimeline {
  id        String       @id @default(cuid())
  report    Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId  String
  status    ReportStatus
  notes     String?
  user      User?        @relation(name: "UserTimelineEntries", fields: [userId], references: [id], onDelete: SetNull)
  userId    String?
  timestamp DateTime     @default(now())

  @@index([reportId])
  @@index([userId])
  @@index([timestamp])
}

model InvestigationDocument {
  id           String       @id @default(cuid())
  report       Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId     String
  fileName     String
  fileType     String
  fileSize     Int
  // Simpan path di storage, buat signed URL saat akses
  storagePath  String
  documentType DocumentType
  uploadedBy   User?        @relation(name: "UserDocuments", fields: [uploadedById], references: [id], onDelete: SetNull)
  uploadedById String?
  description  String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([reportId])
  @@index([uploadedById])
}

model Notification {
  id                String           @id @default(cuid())
  user              User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId            String?
  type              NotificationType
  title             String
  message           String
  isRead            Boolean          @default(false)
  relatedEntityId   String?
  relatedEntityType String?
  createdAt         DateTime         @default(now())
  readAt            DateTime?
  updatedAt         DateTime         @updatedAt

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Article {
  id          String        @id @default(cuid())
  slug        String        @unique
  title       String
  content     String
  excerpt     String?
  status      ArticleStatus @default(DRAFT)
  author      User?         @relation(fields: [authorId], references: [id], onDelete: SetNull)
  authorId    String?
  publishedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([authorId])
  @@index([status])
  @@index([publishedAt])
}

model ActivityLog {
  id          String   @id @default(cuid())
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId      String?
  action      String
  entityType  String?
  entityId    String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  report      Report?  @relation(name: "ReportActivityLogs", fields: [reportId], references: [id], onDelete: SetNull)
  reportId    String?

  @@index([userId])
  @@index([reportId])
  @@index([timestamp])
  @@index([action])
}
